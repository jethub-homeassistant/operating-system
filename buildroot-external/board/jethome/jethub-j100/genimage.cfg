image overlay.ext4 {
	size = ${OVERLAY_SIZE}
	empty = "yes"

	ext4 {
		use-mke2fs = "yes"
		label = "os-overlay"
		extraargs = "-I 256 -E lazy_itable_init=0,lazy_journal_init=0"
	}
}

image "${IMAGE_NAME}.img" {
	size = "${DISK_SIZE:-1G}"

	hdimage {
        partition-table-type = "mbr"
        align = 1M
        disk-signature = 0x48617373
        extended-partition = 2
    }

    partition spl {
        size = ${BOOT_SPL_SIZE}
        image = "u-boot.bin.sd.bin"
        in-partition-table = "no"
        offset = 0
        holes = {"(440; 512)"}
    }

	partition os-reserved {
		offset = 4M
		size = 124M
	}

	partition os-bootstate {
		offset = 129M
    	size = ${BOOT_ENV_SIZE}
		partition-type = 0x83
	}

	partition os-systemA {
		offset = 132M
		size = ${SYSTEM_SIZE}
		image = ${SYSTEM_IMAGE}
	}

	partition os-systemB {
		offset = 389M
		size = ${SYSTEM_SIZE}
		image = ${SYSTEM_IMAGE}
	}

	partition os-overlay {
		offset = 646M
    	size = ${OVERLAY_SIZE}
		partition-type = 0x83
    	image = "overlay.ext4"
	}

	partition os-reserved_end {
		offset = 711M
    	size = 313M
    	partition-type = 0x83
	}
}

image "${IMAGE_NAME}.raucb" {
    rauc {
        key = "/build/key.pem"
        cert = "/build/cert.pem"
        keyring = "${TARGET_DIR}/etc/rauc/keyring.pem"
        manifest = "${RAUC_MANIFEST:-PLEASE_SPECIFY_RAUC_MANIFEST}"
        file hook { image = "${BR2_EXTERNAL_JHOS_PATH}/ota/rauc-hook" }
        file uboot { image = "${BINARIES_DIR}/u-boot.bin.sd.bin" }
        file kernel.img { image = "${BINARIES_DIR}/Image" }
        file rootfs.img { image = ${SYSTEM_IMAGE} }
    }
}