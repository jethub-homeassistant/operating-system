image overlay.ext4 {
	size = ${OVERLAY_SIZE}
	empty = "yes"

	ext4 {
		use-mke2fs = "yes"
		label = "os-overlay"
		extraargs = "-I 256 -E lazy_itable_init=0,lazy_journal_init=0"
	}
}

image "${IMAGE_NAME}.img" {
	size = "${DISK_SIZE:-1G}"

	hdimage {
        align = 1M
		partition-table-type = "none"
    }

    partition spl {
        size = ${BOOT_SPL_SIZE}
        image = "u-boot.bin.sd.bin"
        in-partition-table = "no"
        offset = 0
        holes = {"(440; 512)"}
    }

	partition os-reserved {
		offset = 4M
		size = 124M
	}

	partition os-bootstate {
		offset = 128M
    	size = ${BOOT_ENV_SIZE}
	}

	partition os-systemA {
		size = ${SYSTEM_SIZE}
		image = ${SYSTEM_IMAGE}
	}

	partition os-systemB {
		size = ${SYSTEM_SIZE}
		image = ${SYSTEM_IMAGE}
	}

	partition os-overlay {
    	size = ${OVERLAY_SIZE}
    	image = "overlay.ext4"
	}

	partition os-reserved_end {
    	size = 318M
	}
}

image "${IMAGE_NAME}.raucb" {
    rauc {
        key = "/build/key.pem"
        cert = "/build/cert.pem"
        keyring = "${TARGET_DIR}/etc/rauc/keyring.pem"
        manifest = "${RAUC_MANIFEST:-PLEASE_SPECIFY_RAUC_MANIFEST}"
        file hook { image = "${BR2_EXTERNAL_JHOS_PATH}/ota/rauc-hook" }
        file uboot { image = "${BINARIES_DIR}/u-boot.bin.sd.bin" }
        file kernel.img { image = "${BINARIES_DIR}/Image" }
        file rootfs.img { image = ${SYSTEM_IMAGE} }
    }
}